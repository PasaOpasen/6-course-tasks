---
title: "Регрессионные модели для определения повторного максимума для силовых упражнений"
author: '[Дмитрий Пасько](https://github.com/PasaOpasen)'
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  word_document:
    toc: yes
    reference_docx: Template.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,include = TRUE,tidy = TRUE,cache = FALSE,eval = TRUE, message = FALSE,warning = FALSE,fig.align = "center", out.width = '90%')
```

```{r,echo=FALSE}
library(knitr)
library(pander)
library(xtable)
library(stargazer)

#Загрузка данных####
library(tidyverse)
library(magrittr)
library(ggformula)
library(ggthemes)
library(tidyquant)
library(ggvis)
library(plotrix)
library(car)
#library(DAAG)
library(leaps)

data=read_tsv("data(rus).tsv",
              skip=1,col_names = F,na="",
              col_types = "fddnfffnnnff",
              comment="#"
              ) %>% tbl_df()

colnames(data)=c("Date","RM","MRM","Count","Action","Sex","Experience","Age","Weight","Height","BodyType","Mail")
data %<>%#filter(Count<=20) %>% 
  arrange(MRM,Count,Weight) %>%  mutate(
  CountGroup=cut(Count,breaks = c(1,3,6,10,20,40)),
  AgeGroup=cut(Age,breaks = c(1,19,27,35,70)),
  Experience=factor(Experience,levels = c("До двух лет","2-3 года","4-5 лет","6-10 лет","11-15 лет" ,"больше 15 лет"),ordered = T),
  Index=Weight/(0.01*Height)^2,
  IndexGroup=cut(Index,breaks = c(0,16,18.5,24.99,30,35,40,60))
  )%>% select(-Date)#,-Mail) %>% filter(Count>1,MRM<RM)
levels(data$CountGroup)=c("2-3","4-6","7-10","11-20",">20")
levels(data$AgeGroup)=c("<20","20-27","28-35",">35")
levels(data$IndexGroup)=c("выраженный дефицит","дефицит","норма","избыток","ожирение1","ожирение2","ожирение3")

ex=data$Experience %>% as.numeric()
ex[ex==6]=5
ex %<>%factor() 
levels(ex)=c("До двух лет","2-3 года","4-5 лет","6-10 лет","больше 10 лет")
data %<>%mutate(Experience=factor(ex,ordered = T)) 

allrows=1:nrow(data)
maxerror=5

#уникальные записи (где один от каждого человека берётся только одна запись)
#объяснить, по каким признакам людей считать одинаковыми
data.unique=data %>% select(AgeGroup,Height,BodyType,Experience,Sex,IndexGroup) %>% unique()

#функции
getparam=function(vec){
  ln=length(levels(vec))
  x=numeric(ln)
  ns=character(ln)
  for(i in seq(ln)){
    x[i]=sum(vec==levels(vec)[i])/length(vec)
    ns[i]=paste0(levels(vec)[i]," (",round(x[i]*100,2),"%)")
  }
  return(list(x=x,ns=ns))
}

getPIE=function(vec,main=""){
  lst=getparam(vec)
  pie(x=lst$x,labels=lst$ns,main=main)
}
getFan=function(vec,main=""){
  pr=getparam(vec)
  fan.plot(pr$x,labels=pr$ns,main=main)
}



data.backup=data



```

***
# ВВЕДЕНИЕ

## Зачем предсказывать повторные максимумы?

Очень часто при подготовке к соревнованиям по пауэрлифтингу или в процессе любительских тренировок **полезно (а иногда и необходимо) оценить свои текущие возможности, не делая "проходку"**, так как "проходка" оказывает сильное воздействие на нервную систему, её нежелательно делать часто и к ней нужно сначала подготавливаться, затем от неё отдыхать (чтобы суметь мобилизовать больше ресурсов и уменьшить риск травм), что занимает много времени и сил --- и всё ради того, чтобы просто узнать, какой именно вес ты способен пожать, присесть или потянуть конкретно сейчас. Гораздо разумнее было бы оценить эти величины (*повторные максимумы*, **ПМ**^[иногда их называют *разовыми максимумами*, **РМ**]), основываясь на результатах, которые ты показывал совсем недавно в процессе обычных тренировок или которые намного проще продемонстрировать^[имеется ввиду, что нетрудно и более безопасно на следующей тренировке взять достаточно большой вес и сделать с ними максимальное число повторений (около 4-8)] (*многоповторные максимумы*, **МПМ**). Кроме того, *если удастся построить такую модель, способную оценить силу человека, исходя из его последних достижений, можно будет сделать более явной связь между тренировками и реальными результатами, предотвращая перетренированность и временные потери на тренировки по программам, не дающим эффекта*.

Итак. **Зачем нужно предсказывать повторные максимумы?** Регрессионные модели, которые требуется построить, помогут:

1. адекватно оценить свои возможности перед соревнованиями и заказать веса, очень близкие к реальному максимуму; кроме того, **знать свой ПМ, не делая проходку, очень важно не только для тех, кто занимается пауэрлифтингом** (см. [статью](https://body1.ru/kalkulyator-odnopovtornogo-maksimuma-1pm/));

1. в период подготовки **оценивать скорость своего прогресса (или вообще его наличие), предотвращая перетренированность**; сравнивать свои результаты с результатами предыдущих циклов, даже если тогда использовалось другое число повторений;

1. **более обоснованно планировать программу тренировок**: пытаясь чередовать разные упражнения и разные диапазоны повторений, легко сделать программу, которая на самом деле не будет давать значимого эффекта или потребует неподъёмных усилий;

1. обосновать действенность разных методик и выразить различия между ними (этому посвящён последний раздел статьи); 

1. более точно замерять силовые качества групп мышц-антагонистов (очень редко для этого вообще возможно измерять 1ПМ у обеих групп, как и МПМ при одном и том же числе повторений);

1. выявить математические закономерности в силовых показателях человека.

## О калькуляторах

К сожалению, многие люди отнеслись к этому исследованию очень скептически, поскольку уверены, что здесь имеется слишком сложная зависимость, чтобы её можно было описывать^[зачастую так думают, люди, которые своему опыту доверяют намного больше, чем научному знаю, тем более в спортивном мире часто всплывают разные псевдонаучные методики, которые приносят спортсменам только вред]; другие утверждали, что знание такой информации принесёт больше вреда, чем пользы, если спортсмен не имеет большого опыта или не тренируется с тренером. Во многом они правы, но на самом деле, как я считаю, **такое мнение обусловлено достаточно большим количеством разных калькуляторов и формул в Интернете, которые дают разные результаты и не ясно на чём основываются** (на каких формулах либо откуда полученных). 

Примеры: 

* формула из книги Брендона Лилли, с которой началось исследование. За более чем месяц я так и не получил ответа от руководства сайта [Juggernaut](https://www.jtsstrength.com), откуда взялась эта формула (чуть позже я выяснил, что это округлённая **формула Вендлера**);

* калькулятор на (весьма хорошем) сайте [Symmetric Strength](https://symmetricstrength.com), аналогичная ситуация;

* формулы [Мориса и Райдина](https://power-fitness.ru/metod-morisa-i-rajdina-ili-kak-uznat-svoj-maksimum-v-zhime-lezha.html), которые, как позже будет показано, нерабочие и, скорее всего, получены из слишком маленьких выборок;

* формулы [О Коннора, Бжицки (Бржыки), Лэндера](http://frs24.ru/st/maksimum-v-zhime-lezha-raschet/) и [другие](https://ru.wikipedia.org/wiki/Одно_повторение_с_максимальным_весом);

* также [этот калькулятор](https://powerliftingrating.ru/repeat_calculator), [этот](http://evgeniyfit.ru/fitnes-kalkulyatoryi/odnopovtornyiy-maksimum-online/), [этот](https://body1.ru/kalkulyator-odnopovtornogo-maksimuma-1pm/) и разные клоны одних и тех же калькуляторов.

По-видимому, многие люди пытались составить формулы для вычисления повторного максимума, но теперь, помимо самих формул, об этих исследованиях мало что известно. 

**Цель же этой статьи -- предоставить формулу, полученную в согласовании с концепциями машинного обучения, которая будет хорошо работать на многих людях, а не на десяти**. Здесь написано, как она получена и почему.



## О данных и ресурсах
Для сбора наблюдений был создан [опрос в Google Forms](https://forms.gle/R4zZqQJ3ggNdEuQ67) на русском языке и [его англоязычный аналог](https://forms.gle/dbthrvE5Y95beqUL9). 

Русскоязычный опрос распространялся через соц. сеть ВКонтакте преимущественно^["преимущественно" означает, что предположительно именно из этих группы поступила основная масса опрошенных] в следующих группах: [Пауэрлифтинг | Тяжелая атлетика](https://vk.com/powerliftingnews), [Я ♥ ПАУЭРЛИФТИНГ](https://vk.com/ilovepowerlifting), [ПАУЭРЛИФТИНГ И ЖИМ ЛЁЖА 18+](https://vk.com/powerliftingworld), [Твой Тренер](https://vk.com/tvoytrenercom); аналогично англоязычный опрос распространялся на Facebook преимущественно здесь: [Powerlifting Motivation](https://www.facebook.com/PowerliftingMotivation/), [International Powerlifting League (IPL)](https://www.facebook.com/groups/IPLPowerlifting/), [Powerlifting Motivation Chat](https://www.facebook.com/groups/powerliftingmotivation/), [Powerlifting Memes](https://www.facebook.com/groups/powerliftingmemes/). Кроме того, несколько наблюдений я собрал лично.

Спустя два месяца от создания опросов данные были выгружены и началась их обработка. Теперь эти данные и всё, связанное с ними (в том числе последняя версия этого документа), хранятся [в моём репозитории](https://github.com/PasaOpasen/Powerlifting-training-diary-and-articles/tree/master/Estimating%20RM).

Для обработки данных и создания отчёта использовалась среда [RStudio](https://rstudio.com) и **язык R версии `r getRversion()`**. 

## Отправная точка
В книге ["Система тренировок КУБ"](https://forum.steelfactor.ru/index.php?showtopic=44596) на странице 23 (34 в оригинальной версии) приводится формула для определения повторного максимума: 
                    $$предполагаемый\ повторный\ максимум = вес * (1 + 0.0333 * повторения),$$ 
                    
где берётся некоторый рабочий вес и максимально возможное число повторений с ним. В оригинальных обозначениях:

$$RM=WEIGHT \cdot (1+0.0333\cdot REPS).$$

К примеру, если вы можете пожать 100 кг на 5 раз, то из этой формулы следует, что вы сможете пожать 115 на раз и 90 на 9 раз (звучит правдоподобно).

К слову, примерно такая модель с некоторыми поправками на диапазон повторений используется на сайте [Symmetric Strength](https://symmetricstrength.com). Там максимально возможное количество повторений равно 10. 

Лично на мне эта формула хорошо работает и мне захотелось уточнить её для других людей разной комплекции и уровня подготовки. Также интересно то, что **здесь имеется, по сути, очень простая линейная модель с двумя *предикторами* **: рабочим весом и *взаимодействием* рабочего веса с числом повторений, и нет зависимости от самого упражнения, опыта человека и других характеристик, то есть **в перспективе возможно с большой точностью описать наши возможности одной простой формулой, и это будет верно почти для всех людей, невзирая на все различия между ними**.

## Гипотеза и допущения

**Сила человека в одном повторении зависит от пяти составляющих**:

1. **Количество миофибрилл в мышечном волокне**. Чем их больше, тем б**о**льшую силу может развить волокно.

1. **Запасы АТФ и креатинфосфата и уровень ферментации, поддерживающий быстрое преобразование креатинфосфата в АТФ**. Если эти запасы малы, спортсмен не сможет поддерживать максимальное усилие нужные несколько секунд. Сам по себе уровень ферментации для силовых нагрузок можно не учитывать, поскольку после нескольких минут хорошей разминки он становится достаточно высоким.

1. **Соотношение красных и белых мышечных волокон в работающей мышце**: чем больше белых волокон, тем б**о**льшую силу способна развить мышца на короткий промежуток времени. Это соотношение является разным для разных мышц и разных людей (определяется генетикой) и, как пока считается, плохо поддаётся коррекции[^5].

1. **Количество вовлечённых в работу волокон**. Чем их больше, тем больше сила мышцы. Количество задействованных волокон зависит от *импульса ЦНС* и *порога действия органов Гольджи* : чем сильнее импульс, тем больше волокон может вовлечься в работу, однако импульсы выше некоторого порога подавляются органами Гольджи, чтобы человек не мог сознательно применить силу, способную привести к разрыву сухожилий. Тренировки с субмаксимальными и запредельными весами способны воздействовать как на способность генерировать импульс, так и на порог его подавления^[речь идёт о тренировках с более чем 90% от ПМ или с более чем 100% от ПМ в частичной амплитуде, а также об изометрических упражнениях; во многом такие упражнения выполняются для того, чтобы приучить организм поднимать огромные веса, что и значит -- тренировка способности генерировать б**о**льший импульс и увеличение порога его подавления].

1. **Естественные рычаги человека и техника выполнения упражнения**. У каждого человека есть свои рычаги, дающие ему преимущества в тех или иных типах движений. Кроме того, можно откорректировать технику выполнения упражнения так, что амплитуда движения уменьшится в несколько раз, вдобавок при движении основную работу будут выполнять наиболее сильные пучки мышц. Этот фактор не относится конкретно к силе, но фактически его учёт поможет увеличить демонстрируемые результаты.


[^5]: если будет доказано наличие гиперплазии (деления мышечных волокон) в скелетных мышцах человека, можно будет утверждать, что силовые тренировки увеличивают количество белых волокон в работающих мышцах

Подытожив, можно сказать, что **сила спортсмена зависит от генетики (в плане соотношения мышечных волокон, рычагов и т. п.), опыта тренировок (чем больше опыт, тем больше может быть как импульс ЦНС, так и порог его подавления, так и запасы креатинфосфата и т. п.) и конституции (типа телосложения, роста как такового, соотношения роста и функционального веса)**. Сама техника упражнений учитываться не будет.

**Гипотеза исследования** состоит в том, что одноповторный максимум можно с небольшими ошибками предсказать через многоповторный при помощи модели вида

$$RM=MRM \cdot (x+y\cdot REPS)+f(MRM,HEIGHT,WEIGHT)+\varepsilon$$
с поправками на телосложение, опыт тренировок, диапазон повторений или некоторые другие факторы. 

Здесь $x, y$ -- некоторые числа, $f$ -- функция, которую ещё придётся подобрать, $\varepsilon$ -- ошибка, вносимая неучтёнными факторами. При этом предполагается, что искомая зависимость очень близка к линейной, то есть первое слагаемое вносит основной вклад в сумму; это объясняется тем, что интуитивно ясно логическое заключение: из $50*6 \approx 60$ (вес 50 на 6 раз примерно значит 60 на раз) должно следовать $100*6 \approx 120$ с, возможно, небольшими поправками (до 10%) на другие факторы (функция $f$). С другой стороны, формула должна быть верна независимо от того, указывается вес в килограммах или фунтах.


**Поправка на диапазон повторений имеет следующие соображения**. Ввиду физиологии **в разных диапазонах повторений проявляются разные мышечные способности, не все из которых тесно связаны с целевыми мышечными качествами -- абсолютной силой и мощностью**. Почти очевидно, что сила человека в одном повторении хорошо коррелирует с силой в двух-пяти повторениях, но **то, поднимет ли человек указанный вес на 12 раз или на 20, зависит от его силовой выносливости, которая не вносит большого вклада при работе на одно повторение**. Если не вдаваться в подробности, это объясняется тем, что в малом числе повторений основную роль играют запасы креатинфосфата и АТФ, ферментация, напряжение нервного импульса, количество задействованных белых волокон и их сечение, а в большом числе повторений (больше 10-15) существенную роль играет тренированность красных волокон и способность мышц быстро утилизировать продукты метаболических реакций^[в некотором смысле это одно и то же] (если утилизация быстрая, спортсмен сможет сделать на 3-5 повторений больше, а если медленная, то даже огромная сила воли не поможет сделать 2-3 лишних повторения из-за чувствительности к падению pH).

Согласно Хетфилду, сила развивается исключительно при работе с весами не меньше 80% от ПМ и при этом спортсмены среднего уровня способны выполнить 10-15 повторений с 80% от своего ПМ; **то, какой вес человек поднимает на более чем (предположительно) 15 раз, мало говорит о том, какой вес он способен взять на раз**.  

Кроме того, [в статье Вадима Протасенко](https://github.com/PasaOpasen/Powerlifting-training-diary-and-articles/blob/master/Материалы%20по%20пауэрлифтингу%20и%20не%20только/Тренинг/Вадим%20Протасенко.%20Супертренинг%20без%20заблуждений.pdf) прослеживается такая идея: **разное число повторений требует своего времени на выполнение, а в зависимости от времени работы мышцы включается свой режим энергообмена**: примерно через 7 секунд работы запасы креатинфосфата израсходованы больше чем наполовину, алаклатный режим работы (за счёт креатина) завершается через 12 секунд, потом начинается гликолиз (за счёт гликогена), а через 30-60 секунд работы начинается окисление. При этом, если учитывать, что за 30 секунд обычно делается 10 повторений в жиме и 8 в приседе/тяге, можно сделать выводы, что чисто силовые качества проявляют себя (конечно, приблизительно) в первых пяти повторениях, а силовая выносливость заканчивает оказывать влияние на 15-м повторении; всё, что выше 15-20-ти повторений -- вообще не имеет отношения к силе[^6].

[^6]: конечно, это лишь условные размышления без учёта особенностей отдельных частей тела и того, что ввиду усталости каждое следующее повторение делается дольше предыдущего. Важно лишь усвоить, что разные диапазоны повторений по-разному связаны с силой.

<p align="center">
  <img src="Время подхода.png">
</p>


***
# Описание выборки и разведочный анализ данных

## О прошедших опрос
С помощью опроса было получено **всего `r nrow(data)` достоверных наблюдения** (исключая явные аномалии), принадлежащие предположительно **`r nrow(data.unique)`** людям[^10]; они содержатся в файле [data(rus).tsv](https://github.com/PasaOpasen/Powerlifting-training-diary-and-articles/blob/master/Estimating%20RM/data(rus).tsv).

Все наблюдения содержат информацию о нескольких переменных. После некоторых преобразований над этими переменными получаем следующий набор предикторов:

[^10]: дело в том, что одни и те же люди могли вносить более одного ответа. В итоге два наблюдения считаются принадлежащими одному человеку, если они совпадают по переменным **AgeGroup**, **Height**, **BodyType**, **Experience**, **Sex**, **IndexGroup** (которые вряд ли изменятся за время между фиксацией разных наблюдений)

* **RM** -- собственно повторный максимум

* **MRM** -- многоповторный максимум

* **Count** -- количество повторений для многоповторного максимума

* **Action** -- движение для которого верны измерения (`r data$Action %>% levels()` -- самые базовые упражнения)

* **Sex** -- пол испытуемого

* **Experience** -- группа опыта (`r data$Experience %>% levels()`)

* **Age** -- возраст

* **Weight** -- собственный вес

* **Height** -- рост

* **BodyType** -- тип телосложения (`r data$BodyType %>% levels()`). Типы телосложения в целом различаются скоростью обмена веществ и строением скелета, рычагами (хотя различия в строении скелета во многом являются следствием скорости обмена веществ) 

* **CountGroup** -- группа по диапазону повторений (`r data$CountGroup %>% levels()`)

* **AgeGroup** -- возрастная группа (`r data$AgeGroup %>% levels()`)

* **Index** -- [индекс массы тела](https://ru.wikipedia.org/wiki/Индекс_массы_тела), **ИМТ**

* **IndexGroup** -- группа по индексу массы тела (`r data$IndexGroup %>% levels()` в соответствии с рекомендациями ВОЗ)

Основные статистики по данным переменным:

```{r,echo = F}
numcols=sapply(data,is.numeric)

#для числовых переменных
tt=data[,numcols]%>% psych::describe() 
tt[,c(3,4,5,7,8,9,10)]%>% kable(digits=3)

#для факторных переменных
data[,!numcols] %>% select(-Mail) %>% 
  summary() %>% 
  kable(caption='Количество наблюдений в каждой группе по факторным переменным')

```

**Сделаем некоторые выводы о выборке**. Почти все испытуемые -- мужчины, поэтому *результаты, которые будут получены, не следует обобщать на женщин*. Возможно даже, что позднее придётся удалить принадлежащие женщинам наблюдения из выборки, если окажется, что те сильно выделяются.

```{r}
getPIE(data.unique$Sex,main = "Пол испытуемых")
```


Среди испытуемый почти половину составляли эндоморфы:
```{r,echo=F}
getPIE(data.unique$BodyType,main="Тип телосложения испытуемых")
```

и тест хи-квадрат говорит, что это отличие статистически значимо, то есть **среди пауэрлифтеров эндоморфы встречаются чаще эктоморфов или мезоморфов**:
```{r}
chisq.test(data.unique%>% filter(Sex=="Мужчина") %>%select(BodyType) %>% table()) %>% pander::pander()
```

Больше половины наблюдений относятся к жиму лёжа. Я думаю, это связано с тем, что большинство спортсменов просто предпочитают это упражнение двум другим, вдобавок на жиме лёжа относительно проще замерять МПМ и, скорее всего, многие из ответивших специализировались именно на жиме лёжа (жимовики).
```{r}
getPIE(data$Action, main="Движение")
```

**Распределение по другим факторам**:

```{r,cache=T,out.width='85%'}
par(mfrow=c(1,1),mai=rep(0.7,4))
getPIE(data$CountGroup,main = "Диапазон повторений")
getPIE(data$Experience,main = "Опыт тренировок")
getPIE(data$AgeGroup,main = "Возрастная группа")
#getPIE(data$IndexGroup,main = "Группа по индексу массы тела")
par(mfrow=c(1,1))


ggplot(data,aes(x=Experience,fill=AgeGroup))+geom_bar()+theme_classic()+labs(title="Распределение по опыту тренировок",x="Опыт тренировок",y="Количество",fill="Возраст")

ggplot(data,aes(x=AgeGroup,fill=IndexGroup))+geom_bar()+theme_classic()+labs(title="Распределение по возрасту",x="Возрастная группа",y="Количество",fill="ИМТ")
```

**Распределение по индексу массы тела**:

```{r,out.width='90%'}
#среди эндоморфов избыток веса встречается почаще
data.unique %$%  table(BodyType,IndexGroup) %>% kable()

ggplot(data.unique,aes(x=BodyType,fill=IndexGroup))+geom_bar(position=position_dodge2())+
  labs(x="Тип телосложения",y="Количество ответивших",fill="Индекс массы тела")+
  coord_flip()+theme_bw()+theme(legend.position = "bottom")
```

Видно, что среди ответивших нет людей с дефицитом веса и немалая часть имеет нормальный вес, немалая -- "избыток" (предположительно за счёт мышечной массы), но так называемое **"ожирение1" (с большой вероятностью связанное с жировыми отложениями) у эндоморфов встречается чаще, чем в других телосложениях**. Это подтверждает тест пропорций:

```{r,echo = F}
tb=data.unique%>% 
  mutate(Obees=ifelse(IndexGroup=="ожирение1","да","нет")) %>%
  select(Obees,BodyType) %>% table()

tb %>% t() %>% prop.test() %>% pander()#для всех

data.unique%>% 
  mutate(Obees=ifelse(IndexGroup=="ожирение1","да","нет"),
         Bd=ifelse(BodyType=='Эндоморф',1,0)) %>%
  select(Obees,Bd) %>% 
  table() %>% t() %>% 
  prop.test()%>% pander() # eсли разделить на эндоморфов и всех остальных
```

Аналогично дисперсионный анализ показывает, что **эндоморфы имеют больший ИМТ**:

```{r, echo = F}
aov(Index~BodyType,data) %>% summary() %>% pander()

t.test(data %>% filter(BodyType!='Эндоморф') %>% select(Index) %>%t() %>% as.numeric(),
       data %>% filter(BodyType=='Эндоморф') %>% select(Index)%>%t() %>% as.numeric()) %>% pander()
```



## Взаимодествия переменных

Иллюстрация некоторых парных взаимодействий:
```{r,cache=T,out.width='95%'}
GGally::ggpairs(data%>% select(RM,MRM,Action,BodyType),
                title="Диаграммы взаимодействий между переменными в выборке",
                lower = list(combo = "box")) #%>% ggplotly()
```

**Корреляции количественных переменных**:

```{r}
GGally::ggcorr(data,label=T,label_round = 2)
```


Зависимость повторного максимума от индекса массы тела:

```{r,out.width='90%'}
ggplot(data,aes(x=IndexGroup,y=RM))+geom_boxplot()+facet_wrap(vars(Action))+coord_flip()+
  labs(x="Группа по индексу массы",y="Повторный максимум",
       title="Зависимость повторного максимума от индекса массы тела",
       subtitle = "Из графика видно, что жим лёжа имеет тенденцию увеличиваться\n с ростом индекса массы тела. \nОднако для приседа и тяги это верно лишь до некоторого порога")+
  theme_bw()
  
#ggplot(data,aes(x=IndexGroup,y=RM))+geom_boxplot()+facet_grid(Action~BodyType)

ggplot(data,aes(x=Index,y=RM,col=BodyType))+geom_point()+
  facet_wrap(~Action)+geom_smooth(method = "lm",se = F)+
  theme_bw()+theme(legend.position = "bottom")+
  labs(x="Индекс массы тела",y="Повторный максимум",col="Телосложение",
       title = "Зависимость повторного максимума от индекса массы тела")
```

Оценка коэффициента простой регрессионной модели в зависимости от числа повторений:

```{r,out.width='90%'}
data %>% ggplot(aes(x=factor(Count),y=(RM/MRM-1)/Count))+
  geom_boxplot()+theme_bw()+
  geom_hline(yintercept = 0.0333,size =1.3,col="red")+
  labs(x="Число повторений",title = "Оценка параметра для разного числа повторений",
       subtitle = "Красным цветом обозначен параметр 0.0333 из книги Лилли. \nКак видно, он может быть верен для числа повторений от 2 до 5")

```

Из следующего графика может следовать, что начиная с 8-9 повторений зависимость между МПМ и ПМ ослабевает:

```{r}
data.ct=data %>% filter(Count<=10|Count==12)

#По этому соотношению надо бы выбросы удалить
prc=data.ct %>% ggplot(aes(x=factor(Count),y=100*MRM/RM))+geom_boxplot()+coord_flip()+theme_bw()+
  labs(x="Число повторений",y="Какой процент составляет МПМ от ПМ")
prc #%>% ggplotly() %>% I()
```

Либо здесь имеется проблема с данными, так как на 9-м повторении корреляция резко уменьшается (мало наблюдений):

```{r,echo = F}

tibble('Число повторений'=2:10,
       'Корреляция MRM & RM'=sapply(2:10, function(x) data %>% filter(Count==x) %$% cor(RM,MRM)),
       'Нижняя граница'=sapply(2:10, function(x) data %>% filter(Count==x) %$% cor.test(RM,MRM)$conf.int[1]),
       'Верхняя граница'=sapply(2:10, function(x) data %>% filter(Count==x) %$% cor.test(RM,MRM)$conf.int[2]),
       'Всего наблюдений'=sapply(2:10, function(x) data %>% filter(Count==x) %>% nrow()))%>% 
  kable(caption = "Корреляция между MRM & RM для каждого повторения",align = 'ccccc')

```

**Есть ли разница в этих процентах для разных движений или телосложений? Дисперсионный анализ показывает, что нет**, значимых различий не обнаружено (все p-значения больше 0.05):

```{r,echo = F}
#есть ли разница в проценте в зависимости от чего-то

#cat("p-значения для телосложений:\n")
pvalues1=sapply(2:10, function(x) data %>% filter(Count==x) %$% aov(MRM/RM~BodyType,.)%>% summary() %$% .[[1]][["Pr(>F)"]][1])
names(pvalues1)=paste(2:10,"repeats")


#cat("p-значения для типа движения:\n")
pvalues2=sapply(2:6, function(x) data %>% filter(Count==x) %$% aov(MRM/RM~Action,.)%>% summary() %$% .[[1]][["Pr(>F)"]][1]) %>% round(7)
names(pvalues2)=paste(2:6,"repeats")


#cat("p-значения для групп по индексу массы:\n")
pvalues3=sapply(2:10, function(x) data %>% filter(Count==x) %$% aov(MRM/RM~IndexGroup,.)%>% summary() %$% .[[1]][["Pr(>F)"]][1])
names(pvalues3)=paste(2:10,"repeats")


tibble('Число повторений'=2:10,'p-значения для телосложений'=pvalues1,'p-значения для типа движения'=c(pvalues2,rep('мало данных',4)),'p-значения для групп по индексу массы'=pvalues3)%>% kable(caption = "p-значения для разных факторных переменных на каждом числе повторений",align = 'cccc')

```

Применим **тест Стьюдента для определения предсказываемых процентов и доверительных интервалов для них**:

```{r,echo = F}
df=data %>% mutate(perc=100*MRM/RM) %>% filter((Count<=12&Count%%2==0)|Count==15|Count==20) %>% 
  group_by(factor(Count)) %>% 
  summarise(mean=t.test(perc,conf.level = 0.99)$estimate,
            down=t.test(perc,conf.level = 0.99)$conf.int[1],
            up=t.test(perc,conf.level = 0.99)$conf.int[2]) 
names(df)=c("Число повторений","Ожидаемый %","Нижняя граница","Верхняя граница")

df %>% kable(caption="Какой % составляет МПМ от ПМ",align = 'ccc')
```

В целом эти данные согласуются с тем, что используются [National Strength and Conditioning Association (NSCA)](https://www.nsca.com):

<p align="center">
  <img src="NSCA2.jpg">
</p>

Хотя есть и отличия: вес на 2 повторения скорее равен 94% от максимума, а не 95%, а вес на 12 повторений -- это скорее 70% от максимума, а не 67%.


Теперь посмотрим на зависимость повторного максимума от многоповторного:

```{r,out.width='85%'}
plt=data %>% ggplot(aes(x=MRM,y=RM))+geom_smooth()+
  geom_point(aes(col=CountGroup),size=3)+theme_bw()+
  #facet_grid(vars(CountGroup))+
  labs(x="Многоповторный максимум",y="Повторный максимум",
       col="Диапазон повторений",
       title = "Зависимость повторного максимума от многоповторного")
plt+theme(legend.position = c(0.85,0.2))
```

Очевидно, что здесь будет близкая к линейной зависимость (учитывая высокую корреляцию).
Оказывается, если предварительно разбить наблюдения на группы по повторениями, линейность станет намного более выраженной для числа повторений не больше 10 (для большего числа повторений не прослеживается явной линейности либо из-за недостатка данных, либо по физиологическим причинам, озвученным ранее; для диапазона 11-20 возможна квадратичная зависимость, но мало данных, чтобы что-то подтвердить):

```{r,out.width='90%'}
plt+facet_grid(vars(CountGroup))+theme(legend.position ='bottom')
```

Сказанное выше значит, что для каждого диапазона повторений нужен отдельный анализ.

Есть ли зависимость между отношением $\frac{RM}{MRM}$ в зависимости от опыта тренировок и других факторов? Дисперсионный анализ показывает, что в целом нет:

```{r,echo = F}
#есть ли значимые различия в разных возрастных группах для фиксированного диапазона

tibble(
  'Диапозон повторений'=levels(data$CountGroup),
  'Опыт'=sapply(levels(data$CountGroup),function(x) aov(RM/MRM~Experience,data %>% filter(CountGroup==x))%>% summary()%$% .[[1]][["Pr(>F)"]][1]),
       'Возраст'=sapply(levels(data$CountGroup),function(x) aov(RM/MRM~AgeGroup,data %>% filter(CountGroup==x))%>% summary()%$% .[[1]][["Pr(>F)"]][1]),
       'ИМТ'=sapply(levels(data$CountGroup),function(x) aov(RM/MRM~IndexGroup,data %>% filter(CountGroup==x))%>% summary()%$% .[[1]][["Pr(>F)"]][1]),
       'Телосложение'=sapply(levels(data$CountGroup),function(x) aov(RM/MRM~BodyType,data %>% filter(CountGroup==x))%>% summary()%$% .[[1]][["Pr(>F)"]][1])) %>% 
  kable(caption = 'Значимость различий отношения ПМ к МПМ в каждом диапазоне повторений при разных уровнях факторных переменных',align = 'ccccc')

```

Единственное: обнаружилась разница в зависимости от возраста и индекса массы тела для диапазона повторений 11-20. Возможно, это связано с тем, что в целом с увеличением возраста увеличивается уровень подготовки, отчего на более чем 10 раз удаётся поднимать больший процент от максимального веса.

```{r,out.width='90%'}
ggplot(data,aes(x=AgeGroup,y=RM/MRM))+geom_boxplot()+
  facet_grid(vars(CountGroup))+theme_bw()+
  labs(x="Возраст")
```

Кроме того, **возможна разница между самими упражнениями** (движениями):

```{r,echo = F,out.width='90%'}
# p-значения в зависимости от типа телосложения

(sapply(levels(data$CountGroup),function(x) aov(RM/MRM~Action,data %>% filter(CountGroup==x))%>% summary()%$% .[[1]][["Pr(>F)"]][1])) %>% pander()

ggplot(data %>% filter(Count<=20),aes(x=Action,y=RM/MRM))+geom_boxplot()+
  facet_grid(vars(CountGroup))+theme_bw()+
  labs(x="Движение")+coord_flip()
```


Дополнительные закономерности:

```{r,out.width='85%'}
bx=ggplot(data)+geom_boxplot(aes(x=CountGroup,y=RM/MRM))+
  labs(title = "Отношение повторного максимума к многоповторному \nв зависимости от числа повторений",
       x="Диапазон повторений",y="Отношение повторного максимума к многоповторному",
       caption = "Каждый диапазон повторений действует по своим законам \n и нуждается в собственной версии модели")+
  theme_tq()
bx

bx+facet_grid(~BodyType)+theme_bw()+labs(caption="Для числа повторений до 10 тип телосложения не имеет видимого значения. \nНа высоком числе повторений эндоморфы менее выносливы")
#bx+facet_grid(~Sex)+theme_bw()+labs(caption="caption")

bx+facet_grid(~Action)+theme_bw()+labs(caption="Присед имеет хорошую выносливость на большом числе повторений, жим -- на маленьком",
 subtitle = "Чем отношение ниже, тем более 'выносливы' мышцы в том или ином диапазоне")

```




## Подведение итогов, отбор признаков

Перечислим основные идеи об особенностях данных, сказанные ранее:

* Любые **полученные результаты следует обобщать на женщин**, так как в опросе они почти не участвовали. Возможно, ради точности вычислений даже придётся убрать женщин из выборки;

* **Эндоморфы среди пауэрлифтеров встречаются чаще мезоморфов или эктоморфов. При этом у эндоморфов значимо чаще встречается "ожирение первой стадии", чем у представителей других телосложений**;

* **Результаты в приседе и тяге растут с увеличением индекса массы тела лишь до некоторого порога**. Увеличение индекса массы тела выше "ожирения первой стадии" не будет полезным;

* **Сильная корреляция между индексом массы тела и повторным максимумом наблюдается у мезофорфов -- в жиме, у эктоморфов -- в тяге, у эндоморфов -- в приседе**;

* Не обнаружено значимой разницы значений $\frac{MRM}{RM}$ для разных телосложений, движений, групп по индексу массы, опыта, возраста для любого конкретного числа повторений или диапазона повторений (но при этом обнаружилась разница между движениями для диапазонов повторений до 10); **процентовки от *National Strength and Conditioning Association (NSCA)* с небольшими погрешностями верны для всех спортсменов и всех движений**;

* **Разбиение наблюдений на группы по диапазону повторений (который сделан согласовано с физиологическими соображениями) должно значительно повысить точность модели**, причем для числа повторений до 10-20 эта модель крайне близка к линейной;

* Наблюдения свыше 20 повторений не будут учитываться, так как их мало, вдобавок этот диапазон слабо коррелирует с абсолютной силой;

* **При более чем 10 повторений опытные спортсмены способны поднимать более близкие к максимальным веса, чем неопытные**.


Соображения о предикторах для модели:

* $RM$ (повторный максимум) обязательно зависит как от $MRM$ (многоповторный максимум) и $Count$ (числа повторений), так и от $CountGroup$ -- группы по числу повторений;

* $RM$ может зависеть также от $BodyType$ (типа телосложения) и $Action$ (упражнения) либо от их бинарных модификаций (например, если людей разделить не на 3 телосложения, а на эндоморфов и нет); возможно, стоит также попробовать учесть индекс массы тела или собственно вес, имеющие корреляцию с $RM$ не меньше 0.5.

Дальнейшие действия:

1. Просмотреть, как работает модель Вендлера, и на её примере ознакомиться с шаблоном по оценке качества, который будет использоваться для оценки следующих моделей.

1. Построить разные модели для оценки конкретно $RM$ и выбрать ту, которая более проста и даёт меньшую ошибку кросс-валидации.

1. Аналогично построить модели для $\frac{MRM}{RM}$ и выбрать лучшую.

1. Сравнить две выбранные модели и определить лучшую из них.



***
# Построение моделей

```{r}
data %<>%filter(Count<=20) 
#data %>% summary()

Error=function(target,weight) (target-weight)^2 %>% mean() %>% sqrt()

Show=function(vals,df=data){
  #vals=predict(model,df)
  
  err=df$RM-vals

  rg=range(err)#;print(err);print(rg)
  
  if(rg[1]<0)cat("------------> Наибольшая ошибка в большую сторону:",-rg[1],"\n")
  if(rg[2]>0)cat("------------> Наибольшая ошибка в меньшую сторону:",rg[2],"\n")
  
  s=sum(abs(err)/df$RM*100>maxerror)
  len=length(err)
  cat("Модель ошиблась более чем на",maxerror,"% в",s,"случаях из",len,"(",s/len*100,"%)\n")
  s=sum(abs(err)>maxerror)
  cat("Модель ошиблась более чем на",maxerror,"кг в",s,"случаях из",len,"(",s/len*100,"%)\n")
  
  cat("----------------> Статистика по ошибкам в процентах:\n")
  (abs(df$RM-vals)/df$RM*100) %>% summary() %>% print()
  cat("-------------------> Среднеквадратичная ошибка:", Error(vals,df$RM),"\n")
}

ShowErrors=function(model,power.coef=1,sum.coef=0){
  Show(predict(model,data)*power.coef+sum.coef)
  
  cat("Оценка кросс-валидации для всего набора данных",
      boot::cv.glm(data,glm(formula = model$call$formula,data=data),K=10)$delta[1],"\n")
  cat("Оценка кросс-валидации для не более чем 10 повторений",
      boot::cv.glm(data %>% filter(Count<11),glm(formula = model$call$formula,data=data %>% filter(Count<11)),K=10)$delta[1],"\n") 
  cat("Оценка кросс-валидации для не более чем 6 повторений",
      boot::cv.glm(data %>% filter(Count<7),glm(formula = model$call$formula,data=data %>% filter(Count<7)),K=10)$delta[1],"\n") 
}


ResAn=function(res){
  
  p=ggplot(data %>% mutate(res=res),aes(x=CountGroup,y=res))+
    geom_boxplot()+labs(x="Группа повторений",y="Остатки (цель - предсказание)",title="Распределения остатков в зависимости от группы повторений")+theme_bw()
  print(p)
  
  (p+facet_grid(vars(Action))) %>% print()
  
  (p+facet_grid(vars(BodyType),vars(Action)))%>% print()
  return(0)
}

#из этого графика можно сделать вывод, что модель неплохо работает на диапазоне 2-3, но на диапазоне 13-20 ошибка какая-то сильно отличающаяся от тенденции уменьшения ошибок, так что этот диапазон надо бы и вообще убрать, так как там уже играют роль свойства красных волокон, не говорящие о силе
#ResAn(data$RM-data$MRM*(1+0.0333*data$Count))

ResVal=function(vals)ResAn(data$RM-vals)

#ResGraf=function(model)ResVal(predict(model,data))

mysummary=function(mdl){
 
  cat("-----> ОБЩАЯ ИНФОРМАЦИЯ О МОДЕЛИ:\n");cat("\n")
 gvlma::gvlma(mdl) %>% summary() %>% print();cat("\n")
 
 
 cat("-----> БАЗОВЫЕ ГРАФИКИ:\n");cat("\n")
 par(mfrow=c(2,2))
 plot(mdl)
 par(mfrow=c(1,1)) ;cat("\n")
 
 
 cat("-----> ТЕСТ НА НОРМАЛЬНОСТЬ РАСПРЕДЕЛЕНИЯ ОСТАТКОВ\n");cat("\n")
 shapiro.test(mdl$residuals) %>% print();cat("\n")
 
 qqPlot(mdl,main="Q-Q plot")  
 
 
 cat("-----> ФАКТОР ИНФЛЯЦИИ ДИСПЕРСИЙ:\n");cat("\n")
 vif(mdl)%>% print();cat("\n")

}

all=function(modelka){
  modelka %>% ShowErrors()
  
  modelka %>% predict(data) %>% ResVal()
  
  modelka %>% mysummary()
}

data %<>% mutate(Body2=ifelse(BodyType=="Эндоморф","Endo","NonEndo") %>% factor(),
                Action2=ifelse(Action=="Жим","Up","Down") %>% factor())
```

Вычислительные возможности позволяют создать и проверить огромное количество моделей. Цель исследователя -- предложить несколько вариантов и выбрать среди них лучший. Кроме этого, нужно посмотреть, как работает модель на разных группах данных, чтобы обнаружить выбросы или обнаружить, что на такой-то группе модель вообще не может работать, из-за чего такую группу придётся исключить (эта работа уже проделана при самом исследовании, чтобы не нагружать статью).

Итак, в модели представляют интерес следующие показатели:

* ошибки в разных группах данных;

* выбросы и влиятельные наблюдения;

* статистическая значимость модели;

* оценки кросс-валидации.

## Недостатки исходного решения

Применив формулу $RM=MRM \cdot(1+0.0333 \cdot Count)$ ко всем наблюдениям, получим оценки $RM$ (Fact), которые будут отличаться от истинного $RM$ (Target). Разница между этими величинами -- остатки. Для модели Вендлера остатки будут следующие:

```{r, cache=T}
gb=capture.output(ResVal(data$MRM*(1+0.0333*data$Count))) 
```

Здесь такая логика: чем лучше модель, тем "ящики" тоньше и тем их середины ближе к 0.

В данном случае видно, что **модель Вендлера хорошо работает почти на всех данных из диапазона 2-3 и на немалой части данных из диапазона 4-6**. Для большего числа повторений модель даёт завышенные оценки.

Если посмотреть на численные ошибки

```{r}
Show(data$MRM*(1+0.0333*data$Count))
```

увидим, что модель заметно ошибается в 30% случаев и в среднем на почти 5%. Первые формулы [Мориса и Райдина](https://power-fitness.ru/metod-morisa-i-rajdina-ili-kak-uznat-svoj-maksimum-v-zhime-lezha.html) показывают худший результат:

```{r}
Show(data$MRM*(
  0.969611*exp(0.030583*data$Count)*ifelse(data$Action=="Жим",1,0)+
    0.985993*exp(0.015050*data$Count)*ifelse(data$Action!="Жим",1,0)
))
```

На самом деле это две формулы вида

$$\log \left(\frac{RM}{MRM}\right)= a+b \cdot Count,$$

где $a,b$ зависят от того, к какой части тела относится упражнение. Сама идея сделать логарифмическое преобразование используется нередко, но здесь это имеет негативный эффект: $R^2$ равен далеко не 0.99, как сказано на сайте:

```{r}
lm(log(RM/MRM)~Action2+Count:Action2,data)%>% summary() %>% pander()
```

Скорее всего, формулы Мориса и Райдина подгонялись на маленькой выборке или на выборке, в которой почти все данные принадлежали нескольким людям.


## Уточнение коэффициентов

Теперь возьмём модель вида  $RM=MRM \cdot(a+b \cdot Count)$ и подберём коэффициенты $a,b$ лучшим образом. В итоге:

```{r,out.width='90%'}
lm(RM~MRM+MRM:Count-1,data) -> b1 
b1 %>% all()
```

Выше приведена вся необходимая информация о качестве модели (назовём эту модель $b_1$). Из неё важнее всего следующее:

* На выборочных данных модель ошибается максимум на 21кг и 13%;

* В среднем модель ошибается на 3%;

* В 75% случаев ошибка не превышала 5%;

* Наибольший разброс ошибок приходится на диапазон 11-20;

* Модель статистически значима и удовлетворяет всем нужным требованиям, кроме гетероскедастичности;

* Немало больших ошибок приходится на диапазон 11-20 повторений, содержащий меньше всего наблюдений.

## Уточнение коэффициентов: зависимость от диапазона

Теперь сделаем поправку для коэффициентов $a,b$ в зависимости от факторных переменных. 

Путём подбора удалось найти две схожие модели (назовём их $b_2$ и $b_3$), немного отличающиеся оценками кросс-валидации на разных диапазонах. **Поскольку на диапазоне повторений 11-20 по-прежнему сохранялись сильные ошибки, было принято решение удалить этот диапазон** (также это можно обосновать тем, что на этом диапазоне меньше данных и сложнее отлавливать выбросы, да и физиологически он не так тесно связан с силой, как другие, о чём уже было сказано).


Далее приведён анализ для модели $RM=MRM \cdot(a+b \cdot Count)$, в которой и $a$ и $b$ имеют поправку на диапазон повторений.

```{r}
data %<>%filter(Count<11)
lm(RM~MRM+MRM:Count-1,data) -> b1
b2=lm(RM~MRM:Count:CountGroup+MRM:CountGroup-1,data); b2%>% all()
b3=lm(RM~MRM:Count:CountGroup+MRM:Action-1,data) #%>% all()
```

Аналогичные выводы:

* На выборочных данных модель ошибается максимум на 18кг и 13%;

* В среднем модель ошибается на 3%;

* В 80% случаев ошибка не превышала 5%;

* Наибольший разброс ошибок приходится на диапазон 4-6;

* Модель статистически значима и удовлетворяет всем нужным требованиям, кроме гетероскедастичности;

## Третье поколение моделей

Путём пошагового отбора переменных были найдены ещё две равнозначные модели ($b_4$ и $b_5$), которые, несмотря на б**о**льшую сложность в сравнении с предыдущими, имеют лучшие оценки при кросс-валидации. 

Статистика для модели $b_5$:

```{r, cache=T}
b4=lm(RM ~ MRM:Action + MRM:I(Count^2) + Action2:I(MRM/Weight) + MRM:Count:CountGroup - 1,data)


b5=lm(RM ~ I((MRM/Index)^6) + MRM:CountGroup + MRM:Action + MRM:CountGroup:Count - 1,data)
b5 %>% all()
```

Аналогичные выводы:

* На выборочных данных модель ошибается максимум на 13кг и 12%;

* В среднем модель ошибается на менее 3%;

* В 85% случаев ошибка не превышала 5%;

* В целом, на каждом диапазоне имеется почти одинаковый разброс;

* Модель статистически значима и удовлетворяет всем нужным требованиям.

***
## Сравнение линейных моделей и подведение итогов

```{r,cache=T,echo = F}
kn=c(5,6,7,8,9,10,11,12)

ct=c(8,11)

gr=rep(c('2-10','2-7'),length(kn)) %>% sort(decreasing = T)

m=matrix(nrow=length(kn)*length(ct),ncol=5)

lst=list(b1,b2,b3,b4,b5)


for(i in 1:5){
  
  model=lst[[i]]
  
  for(j in 1:length(ct)){
    dt=data %>% filter(Count<ct[j])
    gl=glm(formula = model$call$formula,data= dt)
    
    getval=function(k){
      boot::cv.glm(dt, gl,K=k)$delta[1] %>% return()
    }
    
    getval.mean=function(k,count){
      map_dbl(1:count,function(x)getval(k)) %>% mean() %>% return()
    }
    
    beg=(j-1)*length(kn)
    
    for(s in 1:length(kn)){
      m[beg+s,i]= getval.mean(kn[s],30)
    }
    #print(m)
  }
  
}

colnames(m)=paste0('b',1:5)
kp=rep(kn,length(ct))

vals=data.frame(kp=rep(kp,5),
                b=as.numeric(m),
                gr=factor(rep(gr,5)),
                n=factor(rep(colnames(m),length(kn)*length(ct)) %>% sort())) %>% 
  tbl_df()

```

В результате перекрёстной проверки для всех моделей при числе блоков `r kn` было обнаружено, что модель $b_5$ значительно превосходит остальные модели, причём это верно, если делать проверку как на всём диапазоне повторений (2-10), так и на более близком к силовому диапазоне 2-7:

```{r,out.width='95%'}
ggplot(vals,aes(x=kp,y=b,col=n))+theme_bw()+facet_grid(vars(gr), scales="free_y")+
  geom_point(size=4)+geom_line(size=1.)+
  labs(x="Количество блоков при перекрёстной проверке",
       y="Усреднённые значения ошибок после 30 повторных проверок",
       col="Модель",
       title="Оценки качества моделей при перекрёстной проверке",
       subtitle = "Оценка производилась на разных подмножествах данных",
       caption = "Очевидно, что пятая модель превосходит остальные по точности")+
  scale_x_continuous(breaks = kn)+
  theme(legend.position = "bottom")
```

На втором месте после модели $b_5$ идёт более простая модель $b_3$. 

**Что это за модели?** Посмотрим на модель $b_3$:

```{r}
b3 %>% summary()# %>% pander()
cf=b3$coefficients
```

Она имеет вид $$RM=MRM \cdot (Action_{coef}+CountGroup_{coef} \cdot Count),$$ 
где $Action_{coef}$ равен `r cf[1]` для жима, `r cf[2]` для тяги и `r cf[3]` для приседа, а $CountGroup_{coef}$ есть поправка на диапазон повторений, равная `r cf[4]` для диапазона 2-3, `r cf[5]` -- для 4-6 и `r cf[6]` -- для 7-10. Как видно, первые три коэффициента близки к единице, однако различия между ними имеют значение; заметим также, что поправка на диапазон повторений 2-3 довольно близка к коэффициенту Вендлера (0.0333).

Кстати, по **точности модель $b_3$ превосходит вторую модель Мориса** (ту, что выражена таблицами для каждого движения):

```{r, echo = F}
#модель Мориса

sq = c(1, 1.0475, 1.13, 1.1575, 1.2, 1.242, 1.284, 1.326, 1.368, 1.41)
pr = c(1, 1.035, 1.08, 1.115, 1.15, 1.18, 1.22, 1.255, 1.29, 1.325)
lf = c(1, 1.065, 1.13, 1.147, 1.164, 1.181, 1.198, 1.232, 1.236, 1.24)


rlt = data$MRM * (
  sq[data$Count] * ifelse(data$Action == "Жим", 1, 0) +
    pr[data$Count] * ifelse(data$Action == "Присед", 1, 0) +
    lf[data$Count] * ifelse(data$Action == "Тяга", 1, 0)
)

Show(rlt)

# модель b3
b3 = lm(RM ~ MRM:Count:CountGroup + MRM:Action - 1, data)
b3 %>% predict(data) %>% Show()

```

Тогда аналогичная таблица, **на сколько нужно умножить свой вес для разного числа повторений**, выглядит так:

```{r}
cf = coefficients(b3)

#надо бы исследовать эти числа
count.vec = 2:10 * c(rep(cf[4], 2), rep(cf[5], 3), rep(cf[6], 4))


tibble(
  'Повторы'=1:10,
  'Присед' = c(1, cf[3] + count.vec),
  'Жим' =  c(1, cf[1] + count.vec),
  'Тяга' =  c(1, cf[2] + count.vec)
) %>% kable(caption = 'На сколько нужно умножить свой вес для разного числа повторений, чтобы получить 1ПМ',align = 'cccc')
```



Модель $b_5$ имеет два дополнительных слагаемых:
```{r}
b5 %>% summary()
cf=b5$coefficients
```
Её вид, аналогично:

$$RM=MRM \cdot (CountGroup_{coef_2} +Action_{coef}+CountGroup_{coef_1} \cdot Count)+coef \cdot\left(\frac{MRM}{Index}\right)^6$$
Здесь $coef$ при последнем слагаемом равен `r sprintf("%.7f", cf[1])`, $Index$ -- индекс массы тела. Дробь внутри последнего слагаемого можно упростить:

$$\frac{MRM}{Index}=\frac{MRM \cdot (0.01 \cdot Height)^2}{Weight}=\frac{MRM \cdot Height^2}{10000\cdot Weight}$$
Вообще *существование этого слагаемого (с шестой степенью) кажется чем-то очень сомнительным, но математика показывает, что это имеет смысл*. **Результаты дисперсионного анализа говорят о том, что
включение указанного коэффициента создаёт значимое отличие между моделями с ним и без него**:

```{r,echo = F}
anova(lm(RM ~  MRM:CountGroup + MRM:Action + 
    MRM:CountGroup:Count - 1, data = data),
      lm( RM ~ I((MRM/Index)^6) + MRM:CountGroup + MRM:Action + 
    MRM:CountGroup:Count - 1, data = data)) %>% pander()
```


Очень интересно, что в этих двух моделях нет зависимости от возраста, типа телосложения, опыта и пола[^11]. 
Конечно, нельзя рассмотреть всевозможные вариации таких моделей, но среди сотни рассмотренных (в том числе с помощью пакета **caret**) не было обнаружено доказательств значимости включения этих факторов в модель. 

[^11]: по крайней мере, наблюдения от женщин, прошедших опрос, не становились выбросами для этих моделей, а хорошо вписывались во многие наблюдения, принадлежавшие мужчинам

Как итог, **для определения ПМ нужны лишь следующие данные**:

* МПМ;

* Число повторений;

* Движение; 

* Рост и вес спортсмена.



***

# ЗАКЛЮЧЕНИЕ

В результате проведённого исследования была найдена модель, не зависящая от типа телосложения, опыта тренировок и многих других характеристик, но при этом дающая хорошие результаты на 85% данных. 

Я уверен, что большие погрешности в единичных случаях -- это та часть закономерности, зависящая от человека и многих неучтённых характеристик. Тем не менее, влияние этих неучтённых факторов далеко не так велико, как предполагали многие: намного больше повторный максимум зависит от обычной математики.

Было продемонстрировано, что для числа повторений выше 10 нельзя построить достаточно точную модель (по крайней мере, при текущем наборе данных), но для диапазона 2-10 -- ещё как можно.

Диапазон выше 10 повторений был отсеян по следующим причинам:

1. физиологически менее сильная связь между 1ПМ и большим числом повторений;

1. меньшая детерминированность между 1ПМ и большим числом повторений, обнаруженная при разведочном анализе данных, отчего трудно выявить достоверность данных и построить достаточно точную модель;

1. маленький объём данных, разбросанных очень неравномерно на большом диапазоне (от 11 до 35).

Посчитать собственные результаты при помощи найденной модели можно [здесь](https://dmitrypasko.shinyapps.io/RMbyMRMestimating/).

***

# Литература

[1] Хэтфилд Ф. К., Всестороннее руководство по развитию силы // Красноярск: Союзспорт, 1992. - 284 с.

[2] Вадим Протасенко. Думай! Или «Супертренинг» без заблуждений.

[3] Уикем Х., Гроулмунд Г. Язык R в задачах науки о данных: импорт, обработка, визуализация и моделирование данных. : Пер. с англ. --- СПб. : ООО "Диалектика", 2018. --- 592 с.

[4] Мастицкий С. Э., Шитиков В. К. Статистический анализ и визуализация данных с помощью R. -- М.: ДМК Пресс, 2015. -- 496 с.

[5] Роберт И. Кабаков. R в действии. Анализ и визуализация данных в программе R. / пер. с англ. Полины А. Волковой. -- М: ДМК Пресс, 2016. -- 588 с.

[6] Джеймс Г., Уиттон Дм Хасти Т., Тибширани Р. Введение в статистическое обучение с примерами на языке R. Пер. с англ. С. Э. Мастицкого - М.: ДМК Пресс, 2016. - 450 с: 

[7] Крупкина, Т. В. Математическая статистика [Электронный ресурс] : курс лекций / Т. В. Крупкина, А. К. Гречкосеев. – Электрон. дан. (3 Мб). – Красноярск : ИПК СФУ, 2009.

[8] Brandon Lilly «The Cube method» (2012)

